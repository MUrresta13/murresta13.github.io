<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="./manifest.webmanifest">
<title>Hunt Scanner</title>
<style>
  :root { --bg:#000; --fg:#f2f5f9; --accent:#ff6a00; }
  *{box-sizing:border-box} html,body{height:100%;margin:0;background:#000;color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .app{position:fixed; inset:0; display:flex; flex-direction:column}
  .view{position:relative; flex:1; background:#000; overflow:hidden}
  video{position:absolute; inset:0; width:100%; height:100%; object-fit:cover; object-position:center; background:#000}
  .toolbar{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:max(14px, env(safe-area-inset-top)) 12px 12px; position:absolute; left:0; right:0; top:0; z-index:5; background:linear-gradient(to bottom, rgba(0,0,0,.65), rgba(0,0,0,0));}
  .title{font-weight:800; letter-spacing:.3px}
  .pill{background: rgba(0,0,0,.45); border:1px solid rgba(255,255,255,.12); padding:8px 12px; border-radius:999px; font-weight:700; color:#fff;}
  .status{position:absolute; left:0; right:0; bottom:0; padding:12px; text-align:center; opacity:.9; background:linear-gradient(to top, rgba(0,0,0,.65), rgba(0,0,0,0));}
</style>
</head>
<body>
<div class="app">
  <div class="view">
    <video id="video" playsinline muted></video>
    <div class="toolbar">
      <div class="title">ðŸŽƒ Hunt Scanner</div>
      <div class="pill" id="support">Checkingâ€¦</div>
    </div>
    <div class="status" id="status">Initializingâ€¦</div>
  </div>
</div>

<script>
if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./sw.js').catch(()=>{}); }

const video = document.getElementById('video');
const statusEl = document.getElementById('status');
const supportEl = document.getElementById('support');

let stream, detector, scanning=false;

function status(msg){ statusEl.textContent = msg; }

async function init(){
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal:'environment' }}, audio:false });
    video.srcObject = stream;
    await video.play();
  } catch(e){ status('Camera permission needed. Check Settings â†’ Safari â†’ Camera â†’ Allow.'); supportEl.textContent='No camera'; return; }

  if ('BarcodeDetector' in window) {
    detector = new BarcodeDetector({ formats:['qr_code'] });
    supportEl.textContent = 'Scanner ready';
    status('Point at a QRâ€¦');
    scanning = true;
    detectLoop();
  } else {
    supportEl.textContent = 'No QR API';
    status('This iPhone does not expose the live QR API. (Settings â†’ Safari â†’ Advanced â†’ Experimental Features â†’ enable Shape Detection/Barcode Detector, or update iOS.)');
  }
}

async function detectLoop(){
  if (!scanning) return;
  try {
    const codes = await detector.detect(video);
    if (codes && codes.length){
      const url = codes[0].rawValue;
      scanning = false;
      location.href = url;
      return;
    }
  } catch(e){ /* keep trying */ }
  requestAnimationFrame(detectLoop);
}

document.addEventListener('visibilitychange', ()=>{
  if (document.hidden) { scanning=false; if (video) video.pause(); }
  else { if (video && stream) video.play(); if (detector){ scanning=true; detectLoop(); } }
});

init();
</script>
</body>
</html>
