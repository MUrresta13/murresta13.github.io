<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="./manifest.webmanifest">
<title>Hunt Scanner</title>
<style>
  :root { --bg:#000; --fg:#f2f5f9; --accent:#ff6a00; }
  *{box-sizing:border-box} html,body{height:100%;margin:0;background:#000;color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  body{display:flex;align-items:center;justify-content:center}
  .app{position:fixed; inset:0; display:flex; flex-direction:column}
  .view{position:relative; flex:1; background:#000; overflow:hidden}
  video{position:absolute; inset:0; width:100%; height:100%; object-fit:cover; object-position:center; background:#000}
  .toolbar{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:max(14px, env(safe-area-inset-top)) 12px 12px; position:absolute; left:0; right:0; top:0; z-index:5; background:linear-gradient(to bottom, rgba(0,0,0,.65), rgba(0,0,0,0));}
  .title{font-weight:800; letter-spacing:.3px}
  .pill{background: rgba(0,0,0,.45); border:1px solid rgba(255,255,255,.12); padding:8px 12px; border-radius:999px; font-weight:700; color:#fff;}
  .footer{position:absolute; left:0; right:0; bottom:0; z-index:5; padding: 12px max(12px, env(safe-area-inset-right)) max(16px, env(safe-area-inset-bottom)) max(12px, env(safe-area-inset-left)); display:flex; align-items:center; justify-content:space-between; gap:10px; background:linear-gradient(to top, rgba(0,0,0,.65), rgba(0,0,0,0));}
  .btn{-webkit-tap-highlight-color:transparent; border:0; border-radius:12px; padding:12px 14px; font-weight:800; background:linear-gradient(135deg, var(--accent), #ff9f1a); color:#111; box-shadow:0 8px 18px rgba(255,106,0,.35);}
  .link{border:1px solid rgba(255,255,255,.25); color:#fff; background:transparent}
  .status{opacity:.9}
</style>
</head>
<body>
<div class="app">
  <div class="view">
    <video id="video" playsinline muted></video>
    <div class="toolbar">
      <div class="title">ðŸŽƒ Hunt Scanner</div>
      <div class="pill" id="support">Checking cameraâ€¦</div>
    </div>
    <div class="footer">
      <div class="status" id="status">Initializingâ€¦</div>
      <button class="btn link" id="fallbackBtn" style="display:none;">Use Photo Scanner</button>
    </div>
  </div>
</div>

<script>
if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./sw.js').catch(()=>{}); }

const video = document.getElementById('video');
const statusEl = document.getElementById('status');
const supportEl = document.getElementById('support');
const fallbackBtn = document.getElementById('fallbackBtn');

let stream, detector, scanning=false;

function status(msg){ statusEl.textContent = msg; }

async function init(){
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal:'environment' }}, audio:false });
    video.srcObject = stream;
    await video.play();
  } catch(e){}
  if ('BarcodeDetector' in window) {
    detector = new BarcodeDetector({ formats:['qr_code'] });
    supportEl.textContent = 'Scanner ready';
    status('Point at a QRâ€¦');
    scanning = true;
    detectLoop();
  } else {
    supportEl.textContent = 'No QR API';
    status('This device lacks the live QR API.');
    fallbackBtn.style.display = 'inline-block';
    fallbackBtn.addEventListener('click', ()=> location.href = './scanner-fallback.html');
  }
}

async function detectLoop(){
  if (!scanning) return;
  try {
    const codes = await detector.detect(video);
    if (codes && codes.length){
      const url = codes[0].rawValue;
      scanning = false;
      location.href = url;
      return;
    }
  } catch(e){}
  requestAnimationFrame(detectLoop);
}
document.addEventListener('visibilitychange', ()=>{
  if (document.hidden) { scanning=false; video.pause(); }
  else { if (video && stream) video.play(); if (detector){ scanning=true; detectLoop(); } }
});
init();
</script>
</body>
</html>
