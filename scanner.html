<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>ðŸŽƒ Hunt Scanner</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
  :root{ --text:#f3f6fb; --muted:#d0d7e2; }
  *{box-sizing:border-box}
  html,body{height:100%; margin:0; background:#000; color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; overflow:hidden;}

  .stage{ position:fixed; inset:0; min-height:100svh; min-height:100dvh; }
  .stage::after{ content:""; position:fixed; left:0; right:0; bottom:0; height:env(safe-area-inset-bottom); background:#000; pointer-events:none; }

  #preview{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; background:#000; }

  .reticle{ position:absolute; left:50%; top:50%; width:min(78vw, 520px); aspect-ratio:1/1; transform:translate(-50%,-50%);
            border-radius:18px; border:3px solid rgba(255,255,255,.5); box-shadow:0 0 0 2px rgba(0,0,0,.25) inset; }
  .chip{ position:absolute; left:14px; top:14px; padding:8px 12px; border-radius:20px; background:rgba(0,0,0,.55); border:1px solid rgba(255,255,255,.15); backdrop-filter: blur(6px); font-weight:800; }
  .hint{ position:absolute; left:0; right:0; bottom: max(8px, calc(8px + env(safe-area-inset-bottom))); text-align:center; color:var(--muted); text-shadow:0 1px 2px #000; }
</style>
</head>
<body>
<div class="stage">
  <video id="preview" autoplay playsinline muted></video>
  <div class="reticle" aria-hidden="true"></div>
  <div class="chip">ðŸŽƒ Hunt Scanner</div>
  <div class="hint" id="hint">Starting cameraâ€¦</div>
</div>

<!-- Software decoder (loaded only if needed) -->
<script id="jsqr-loader" type="application/json">{"loaded":false}</script>
<script>
const preview = document.getElementById('preview');
const hint = document.getElementById('hint');
let stream, stopLoop=false, detector=null, usingJS=false;

function setHint(t){ hint.textContent = t; }
function vibrate(ms=35){ if (navigator.vibrate) try{ navigator.vibrate(ms); }catch(e){} }

async function ensureJsQR(){
  if (window.jsQR) return true;
  const tag = document.createElement('script');
  tag.src = 'https://unpkg.com/jsqr@1.4.0/dist/jsQR.js';
  tag.async = true;
  document.head.appendChild(tag);
  setHint('Loading software scannerâ€¦');
  await new Promise((res, rej)=>{
    tag.onload = ()=>res(true);
    tag.onerror = ()=>rej(new Error('jsQR failed to load'));
  });
  return !!window.jsQR;
}

async function start(){
  try{
    // Prefer native
    if ('BarcodeDetector' in window){
      detector = new BarcodeDetector({ formats:['qr_code'] });
    }
    stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:'environment', width:{ideal:1920}, height:{ideal:1080} },
      audio:false
    });
    preview.srcObject = stream;
    await preview.play();
    setHint('Scanner ready');

    // Try native once; if no results for a bit, switch to JS.
    const nativeWorked = await tryNativeFor(800);
    if (nativeWorked) { return; }

    // Fallback to jsQR
    const ok = await ensureJsQR();
    if (!ok){ setHint('Software scanner unavailable.'); return; }
    usingJS = true;
    jsLoop();
  }catch(err){
    setHint('Camera blocked. Enable in Settings â†’ Safari â†’ Camera.');
  }
}

function openURL(url){
  stop();
  vibrate(35);
  setHint('Openingâ€¦');
  window.location.href = url;
}

function stop(){
  stopLoop = true;
  try{ stream && stream.getTracks().forEach(t=>t.stop()); }catch(e){}
}

function rvfcLoop(callback){
  if ('requestVideoFrameCallback' in preview){
    preview.requestVideoFrameCallback(callback);
  }else{
    requestAnimationFrame(()=>callback(performance.now(), {}));
  }
}

async function tryNativeFor(msWindow){
  if (!detector) return false;
  let found = false;
  const endAt = performance.now() + msWindow;

  const loop = async (now, meta)=>{
    if (stopLoop || now > endAt) return;
    try{
      const bmp = await createImageBitmap(preview);
      const codes = await detector.detect(bmp);
      bmp.close();
      if (codes && codes.length){
        found = true;
        openURL(codes[0].rawValue);
        return;
      }
    }catch(e){}
    rvfcLoop(loop);
  };
  rvfcLoop(loop);

  // wait for the window
  await new Promise(r=>setTimeout(r, msWindow+50));
  if (!found) setHint('Using software scannerâ€¦');
  return found;
}

function jsLoop(){
  if (stopLoop) return;
  const w = preview.videoWidth || 640, h = preview.videoHeight || 480;
  if (!jsLoop.canvas){
    jsLoop.canvas = document.createElement('canvas');
    jsLoop.ctx = jsLoop.canvas.getContext('2d', { willReadFrequently:true });
  }
  const canvas = jsLoop.canvas, ctx = jsLoop.ctx;
  canvas.width = w; canvas.height = h;
  ctx.drawImage(preview, 0, 0, w, h);
  const img = ctx.getImageData(0, 0, w, h);
  try{
    const code = window.jsQR(img.data, img.width, img.height, { inversionAttempts:'attemptBoth' });
    if (code && code.data){
      openURL(code.data);
      return;
    }
  }catch(e){ /* ignore decode errors */ }
  rvfcLoop(()=>jsLoop());
}

start();
</script>
</body>
</html>
